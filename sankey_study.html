<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Study Sankey — Province & Year Filters</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="d3-sankey.js"></script>
  <style>
    body { 
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; 
      margin: 24px; 
    }
    h1 { 
      font-size: 20px; 
      margin: 0 0 8px; 
    }
    .controls { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 12px; 
      align-items: center; 
      margin-bottom: 12px; 
    }
    .controls label { 
      font-weight: 600; 
      font-size: 14px; 
      margin-right: 6px; 
    }
    select { 
      padding: 6px 8px; 
      border-radius: 8px; 
      border: 1px solid #ccc; 
    }
    #chart { 
      width: 100%; 
      height: 720px; 
      overflow: visible;
    }
    .pill { 
      display:inline-block; 
      padding:2px 8px; 
      border:1px solid #ccc; 
      border-radius:999px; 
      margin-left:6px; 
      font-size:12px; 
      color:#333; 
    }
    
    /* D3 Sankey Styles */
    .node rect {
      fill-opacity: 0.9;
      shape-rendering: crispEdges;
      /* stroke and stroke-width now set dynamically for minimum-height nodes */
    }
    .node text {
      font-size: 11px;
      pointer-events: none;
    }
    .link {
      fill: none;
      stroke: rgba(0,0,0,0.2);
      stroke-opacity: 0.5;
    }
    .link:hover {
      stroke-opacity: 0.8;
    }
    
    /* Tooltip */
    .tooltip {
      position: absolute;
      padding: 8px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      border-radius: 4px;
      font-size: 12px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 1000;
    }
    /* Navigation */
    .nav {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 12px 24px;
      margin: -24px -24px 20px -24px;
      display: flex;
      gap: 16px;
      align-items: center;
      flex-wrap: wrap;
    }
    .nav a {
      color: white;
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      padding: 6px 12px;
      border-radius: 6px;
      transition: background 0.2s;
    }
    .nav a:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    .nav a.active {
      background: rgba(255, 255, 255, 0.3);
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="nav">
    <a href="index.html">← Home</a>
    <a href="sankey_imp.html">IMP Sankey</a>
    <a href="sankey_tfw.html">TFW Sankey</a>
    <a href="sankey_pr.html">PR Sankey</a>
    <a href="sankey_asylum.html">Asylum Sankey</a>
    <a href="sankey_study.html" class="active">Study Sankey</a>
  </div>
  <h1>Study Sankey — Province & Year Filters</h1>
  <div class="controls">
    <div>
      <label for="provinceSelect">Province/Territory</label>
      <select id="provinceSelect">
        <option value="ALL" selected>All</option>
      </select>
    </div>
    <div>
      <label for="yearSelect">Year</label>
      <select id="yearSelect">
        <option value="ALL" selected>All</option>
      </select>
    </div>
    <span id="summary" class="pill">All provinces · All years</span>
  </div>
  <div id="chart"></div>
  
  <!-- Small/Zero Value Nodes Legend -->
  <div id="small-nodes-legend" style="margin-top: 16px; font-size: 11px; color: #666;"></div>

  <!-- Tooltip -->
  <div class="tooltip" id="tooltip"></div>

  <!-- The Python script will inject data below by replacing the placeholders. -->
  <script>
    // BEGIN DATA (auto-generated — do not edit by hand)
    const NODES = [{"id": 0, "label": "Study", "level": 0}, {"id": 1, "label": "Education level not stated", "level": 1}, {"id": 2, "label": "Other Studies", "level": 1}, {"id": 3, "label": "Post Secondary", "level": 1}, {"id": 4, "label": "Secondary or less", "level": 1}];
    const LINKS = [{"source": 0, "target": 1, "value": 16, "province_territory": "Alberta", "year": "2015"}, {"source": 0, "target": 2, "value": 1935, "province_territory": "Alberta", "year": "2015"}, {"source": 0, "target": 3, "value": 8950, "province_territory": "Alberta", "year": "2015"}, {"source": 0, "target": 4, "value": 4355, "province_territory": "Alberta", "year": "2015"}, {"source": 0, "target": 1, "value": 44, "province_territory": "British Columbia", "year": "2015"}, {"source": 0, "target": 2, "value": 10140, "province_territory": "British Columbia", "year": "2015"}, {"source": 0, "target": 3, "value": 30985, "province_territory": "British Columbia", "year": "2015"}, {"source": 0, "target": 4, "value": 17855, "province_territory": "British Columbia", "year": "2015"}, {"source": 0, "target": 1, "value": 6, "province_territory": "Manitoba", "year": "2015"}, {"source": 0, "target": 2, "value": 745, "province_territory": "Manitoba", "year": "2015"}, {"source": 0, "target": 3, "value": 5375, "province_territory": "Manitoba", "year": "2015"}, {"source": 0, "target": 4, "value": 1080, "province_territory": "Manitoba", "year": "2015"}, {"source": 0, "target": 2, "value": 131, "province_territory": "New Brunswick", "year": "2015"}, {"source": 0, "target": 3, "value": 1830, "province_territory": "New Brunswick", "year": "2015"}, {"source": 0, "target": 4, "value": 435, "province_territory": "New Brunswick", "year": "2015"}, {"source": 0, "target": 1, "value": 2, "province_territory": "Newfoundland and Labrador", "year": "2015"}, {"source": 0, "target": 2, "value": 88, "province_territory": "Newfoundland and Labrador", "year": "2015"}, {"source": 0, "target": 3, "value": 1420, "province_territory": "Newfoundland and Labrador", "year": "2015"}, {"source": 0, "target": 4, "value": 182, "province_territory": "Newfoundland and Labrador", "year": "2015"}, {"source": 0, "target": 3, "value": 8, "province_territory": "Northwest Territories", "year": "2015"}, {"source": 0, "target": 4, "value": 15, "province_territory": "Northwest Territories", "year": "2015"}, {"source": 0, "target": 1, "value": 2, "province_territory": "Nova Scotia", "year": "2015"}, {"source": 0, "target": 2, "value": 895, "province_territory": "Nova Scotia", "year": "2015"}, {"source": 0, "target": 3, "value": 4310, "province_territory": "Nova Scotia", "year": "2015"}, {"source": 0, "target": 4, "value": 1240, "province_territory": "Nova Scotia", "year": "2015"}, {"source": 0, "target": 3, "value": 2, "province_territory": "Nunavut", "year": "2015"}, {"source": 0, "target": 4, "value": 2, "province_territory": "Nunavut", "year": "2015"}, {"source": 0, "target": 1, "value": 52, "province_territory": "Ontario", "year": "2015"}, {"source": 0, "target": 2, "value": 12295, "province_territory": "Ontario", "year": "2015"}, {"source": 0, "target": 3, "value": 65610, "province_territory": "Ontario", "year": "2015"}, {"source": 0, "target": 4, "value": 21860, "province_territory": "Ontario", "year": "2015"}, {"source": 0, "target": 2, "value": 232, "province_territory": "Prince Edward Island", "year": "2015"}, {"source": 0, "target": 3, "value": 510, "province_territory": "Prince Edward Island", "year": "2015"}, {"source": 0, "target": 4, "value": 179, "province_territory": "Prince Edward Island", "year": "2015"}, {"source": 0, "target": 1, "value": 22, "province_territory": "Quebec", "year": "2015"}, {"source": 0, "target": 2, "value": 3355, "province_territory": "Quebec", "year": "2015"}, {"source": 0, "target": 3, "value": 25400, "province_territory": "Quebec", "year": "2015"}, {"source": 0, "target": 4, "value": 2615, "province_territory": "Quebec", "year": "2015"}, {"source": 0, "target": 1, "value": 2, "province_territory": "Saskatchewan", "year": "2015"}, {"source": 0, "target": 2, "value": 275, "province_territory": "Saskatchewan", "year": "2015"}, {"source": 0, "target": 3, "value": 2775, "province_territory": "Saskatchewan", "year": "2015"}, {"source": 0, "target": 4, "value": 1005, "province_territory": "Saskatchewan", "year": "2015"}, {"source": 0, "target": 2, "value": 6, "province_territory": "Yukon", "year": "2015"}, {"source": 0, "target": 3, "value": 24, "province_territory": "Yukon", "year": "2015"}, {"source": 0, "target": 4, "value": 4, "province_territory": "Yukon", "year": "2015"}, {"source": 0, "target": 1, "value": 14, "province_territory": "Alberta", "year": "2016"}, {"source": 0, "target": 2, "value": 2150, "province_territory": "Alberta", "year": "2016"}, {"source": 0, "target": 3, "value": 10770, "province_territory": "Alberta", "year": "2016"}, {"source": 0, "target": 4, "value": 4165, "province_territory": "Alberta", "year": "2016"}, {"source": 0, "target": 1, "value": 38, "province_territory": "British Columbia", "year": "2016"}, {"source": 0, "target": 2, "value": 9935, "province_territory": "British Columbia", "year": "2016"}, {"source": 0, "target": 3, "value": 38600, "province_territory": "British Columbia", "year": "2016"}, {"source": 0, "target": 4, "value": 20125, "province_territory": "British Columbia", "year": "2016"}, {"source": 0, "target": 1, "value": 6, "province_territory": "Manitoba", "year": "2016"}, {"source": 0, "target": 2, "value": 1025, "province_territory": "Manitoba", "year": "2016"}, {"source": 0, "target": 3, "value": 6795, "province_territory": "Manitoba", "year": "2016"}, {"source": 0, "target": 4, "value": 1270, "province_territory": "Manitoba", "year": "2016"}, {"source": 0, "target": 2, "value": 238, "province_territory": "New Brunswick", "year": "2016"}, {"source": 0, "target": 3, "value": 1865, "province_territory": "New Brunswick", "year": "2016"}, {"source": 0, "target": 4, "value": 585, "province_territory": "New Brunswick", "year": "2016"}, {"source": 0, "target": 2, "value": 90, "province_territory": "Newfoundland and Labrador", "year": "2016"}, {"source": 0, "target": 3, "value": 1655, "province_territory": "Newfoundland and Labrador", "year": "2016"}, {"source": 0, "target": 4, "value": 310, "province_territory": "Newfoundland and Labrador", "year": "2016"}, {"source": 0, "target": 3, "value": 4, "province_territory": "Northwest Territories", "year": "2016"}, {"source": 0, "target": 4, "value": 21, "province_territory": "Northwest Territories", "year": "2016"}, {"source": 0, "target": 1, "value": 2, "province_territory": "Nova Scotia", "year": "2016"}, {"source": 0, "target": 2, "value": 835, "province_territory": "Nova Scotia", "year": "2016"}, {"source": 0, "target": 3, "value": 4985, "province_territory": "Nova Scotia", "year": "2016"}, {"source": 0, "target": 4, "value": 1465, "province_territory": "Nova Scotia", "year": "2016"}, {"source": 0, "target": 1, "value": 44, "province_territory": "Ontario", "year": "2016"}, {"source": 0, "target": 2, "value": 14780, "province_territory": "Ontario", "year": "2016"}, {"source": 0, "target": 3, "value": 88395, "province_territory": "Ontario", "year": "2016"}, {"source": 0, "target": 4, "value": 25795, "province_territory": "Ontario", "year": "2016"}, {"source": 0, "target": 1, "value": 2, "province_territory": "Prince Edward Island", "year": "2016"}, {"source": 0, "target": 2, "value": 227, "province_territory": "Prince Edward Island", "year": "2016"}, {"source": 0, "target": 3, "value": 765, "province_territory": "Prince Edward Island", "year": "2016"}, {"source": 0, "target": 4, "value": 215, "province_territory": "Prince Edward Island", "year": "2016"}, {"source": 0, "target": 1, "value": 20, "province_territory": "Quebec", "year": "2016"}, {"source": 0, "target": 2, "value": 4195, "province_territory": "Quebec", "year": "2016"}, {"source": 0, "target": 3, "value": 27515, "province_territory": "Quebec", "year": "2016"}, {"source": 0, "target": 4, "value": 3100, "province_territory": "Quebec", "year": "2016"}, {"source": 0, "target": 1, "value": 6, "province_territory": "Saskatchewan", "year": "2016"}, {"source": 0, "target": 2, "value": 275, "province_territory": "Saskatchewan", "year": "2016"}, {"source": 0, "target": 3, "value": 3195, "province_territory": "Saskatchewan", "year": "2016"}, {"source": 0, "target": 4, "value": 1050, "province_territory": "Saskatchewan", "year": "2016"}, {"source": 0, "target": 2, "value": 11, "province_territory": "Yukon", "year": "2016"}, {"source": 0, "target": 3, "value": 35, "province_territory": "Yukon", "year": "2016"}, {"source": 0, "target": 4, "value": 12, "province_territory": "Yukon", "year": "2016"}, {"source": 0, "target": 1, "value": 12, "province_territory": "Alberta", "year": "2017"}, {"source": 0, "target": 2, "value": 2015, "province_territory": "Alberta", "year": "2017"}, {"source": 0, "target": 3, "value": 11155, "province_territory": "Alberta", "year": "2017"}, {"source": 0, "target": 4, "value": 4110, "province_territory": "Alberta", "year": "2017"}, {"source": 0, "target": 1, "value": 28, "province_territory": "British Columbia", "year": "2017"}, {"source": 0, "target": 2, "value": 11460, "province_territory": "British Columbia", "year": "2017"}, {"source": 0, "target": 3, "value": 47205, "province_territory": "British Columbia", "year": "2017"}, {"source": 0, "target": 4, "value": 20780, "province_territory": "British Columbia", "year": "2017"}, {"source": 0, "target": 1, "value": 8, "province_territory": "Manitoba", "year": "2017"}, {"source": 0, "target": 2, "value": 1380, "province_territory": "Manitoba", "year": "2017"}, {"source": 0, "target": 3, "value": 8080, "province_territory": "Manitoba", "year": "2017"}, {"source": 0, "target": 4, "value": 1545, "province_territory": "Manitoba", "year": "2017"}, {"source": 0, "target": 2, "value": 243, "province_territory": "New Brunswick", "year": "2017"}, {"source": 0, "target": 3, "value": 1985, "province_territory": "New Brunswick", "year": "2017"}, {"source": 0, "target": 4, "value": 740, "province_territory": "New Brunswick", "year": "2017"}, {"source": 0, "target": 1, "value": 2, "province_territory": "Newfoundland and Labrador", "year": "2017"}, {"source": 0, "target": 2, "value": 145, "province_territory": "Newfoundland and Labrador", "year": "2017"}, {"source": 0, "target": 3, "value": 1815, "province_territory": "Newfoundland and Labrador", "year": "2017"}, {"source": 0, "target": 4, "value": 335, "province_territory": "Newfoundland and Labrador", "year": "2017"}, {"source": 0, "target": 3, "value": 6, "province_territory": "Northwest Territories", "year": "2017"}, {"source": 0, "target": 4, "value": 19, "province_territory": "Northwest Territories", "year": "2017"}, {"source": 0, "target": 1, "value": 6, "province_territory": "Nova Scotia", "year": "2017"}, {"source": 0, "target": 2, "value": 1240, "province_territory": "Nova Scotia", "year": "2017"}, {"source": 0, "target": 3, "value": 5205, "province_territory": "Nova Scotia", "year": "2017"}, {"source": 0, "target": 4, "value": 1625, "province_territory": "Nova Scotia", "year": "2017"}, {"source": 0, "target": 3, "value": 4, "province_territory": "Nunavut", "year": "2017"}, {"source": 0, "target": 4, "value": 2, "province_territory": "Nunavut", "year": "2017"}, {"source": 0, "target": 1, "value": 52, "province_territory": "Ontario", "year": "2017"}, {"source": 0, "target": 2, "value": 21115, "province_territory": "Ontario", "year": "2017"}, {"source": 0, "target": 3, "value": 110415, "province_territory": "Ontario", "year": "2017"}, {"source": 0, "target": 4, "value": 30115, "province_territory": "Ontario", "year": "2017"}, {"source": 0, "target": 2, "value": 285, "province_territory": "Prince Edward Island", "year": "2017"}, {"source": 0, "target": 3, "value": 930, "province_territory": "Prince Edward Island", "year": "2017"}, {"source": 0, "target": 4, "value": 270, "province_territory": "Prince Edward Island", "year": "2017"}, {"source": 0, "target": 1, "value": 14, "province_territory": "Quebec", "year": "2017"}, {"source": 0, "target": 2, "value": 5285, "province_territory": "Quebec", "year": "2017"}, {"source": 0, "target": 3, "value": 30450, "province_territory": "Quebec", "year": "2017"}, {"source": 0, "target": 4, "value": 3725, "province_territory": "Quebec", "year": "2017"}, {"source": 0, "target": 1, "value": 4, "province_territory": "Saskatchewan", "year": "2017"}, {"source": 0, "target": 2, "value": 445, "province_territory": "Saskatchewan", "year": "2017"}, {"source": 0, "target": 3, "value": 3275, "province_territory": "Saskatchewan", "year": "2017"}, {"source": 0, "target": 4, "value": 955, "province_territory": "Saskatchewan", "year": "2017"}, {"source": 0, "target": 2, "value": 11, "province_territory": "Yukon", "year": "2017"}, {"source": 0, "target": 3, "value": 170, "province_territory": "Yukon", "year": "2017"}, {"source": 0, "target": 4, "value": 17, "province_territory": "Yukon", "year": "2017"}, {"source": 0, "target": 1, "value": 10, "province_territory": "Alberta", "year": "2018"}, {"source": 0, "target": 2, "value": 2015, "province_territory": "Alberta", "year": "2018"}, {"source": 0, "target": 3, "value": 13155, "province_territory": "Alberta", "year": "2018"}, {"source": 0, "target": 4, "value": 4105, "province_territory": "Alberta", "year": "2018"}, {"source": 0, "target": 1, "value": 31, "province_territory": "British Columbia", "year": "2018"}, {"source": 0, "target": 2, "value": 11450, "province_territory": "British Columbia", "year": "2018"}, {"source": 0, "target": 3, "value": 52900, "province_territory": "British Columbia", "year": "2018"}, {"source": 0, "target": 4, "value": 20225, "province_territory": "British Columbia", "year": "2018"}, {"source": 0, "target": 1, "value": 4, "province_territory": "Manitoba", "year": "2018"}, {"source": 0, "target": 2, "value": 1480, "province_territory": "Manitoba", "year": "2018"}, {"source": 0, "target": 3, "value": 9585, "province_territory": "Manitoba", "year": "2018"}, {"source": 0, "target": 4, "value": 1570, "province_territory": "Manitoba", "year": "2018"}, {"source": 0, "target": 1, "value": 2, "province_territory": "New Brunswick", "year": "2018"}, {"source": 0, "target": 2, "value": 405, "province_territory": "New Brunswick", "year": "2018"}, {"source": 0, "target": 3, "value": 2465, "province_territory": "New Brunswick", "year": "2018"}, {"source": 0, "target": 4, "value": 955, "province_territory": "New Brunswick", "year": "2018"}, {"source": 0, "target": 2, "value": 147, "province_territory": "Newfoundland and Labrador", "year": "2018"}, {"source": 0, "target": 3, "value": 1890, "province_territory": "Newfoundland and Labrador", "year": "2018"}, {"source": 0, "target": 4, "value": 342, "province_territory": "Newfoundland and Labrador", "year": "2018"}, {"source": 0, "target": 3, "value": 8, "province_territory": "Northwest Territories", "year": "2018"}, {"source": 0, "target": 4, "value": 24, "province_territory": "Northwest Territories", "year": "2018"}, {"source": 0, "target": 1, "value": 8, "province_territory": "Nova Scotia", "year": "2018"}, {"source": 0, "target": 2, "value": 1615, "province_territory": "Nova Scotia", "year": "2018"}, {"source": 0, "target": 3, "value": 6955, "province_territory": "Nova Scotia", "year": "2018"}, {"source": 0, "target": 4, "value": 1685, "province_territory": "Nova Scotia", "year": "2018"}, {"source": 0, "target": 3, "value": 4, "province_territory": "Nunavut", "year": "2018"}, {"source": 0, "target": 4, "value": 4, "province_territory": "Nunavut", "year": "2018"}, {"source": 0, "target": 1, "value": 54, "province_territory": "Ontario", "year": "2018"}, {"source": 0, "target": 2, "value": 23035, "province_territory": "Ontario", "year": "2018"}, {"source": 0, "target": 3, "value": 126310, "province_territory": "Ontario", "year": "2018"}, {"source": 0, "target": 4, "value": 31650, "province_territory": "Ontario", "year": "2018"}, {"source": 0, "target": 2, "value": 370, "province_territory": "Prince Edward Island", "year": "2018"}, {"source": 0, "target": 3, "value": 1085, "province_territory": "Prince Edward Island", "year": "2018"}, {"source": 0, "target": 4, "value": 450, "province_territory": "Prince Edward Island", "year": "2018"}, {"source": 0, "target": 1, "value": 21, "province_territory": "Quebec", "year": "2018"}, {"source": 0, "target": 2, "value": 5820, "province_territory": "Quebec", "year": "2018"}, {"source": 0, "target": 3, "value": 35425, "province_territory": "Quebec", "year": "2018"}, {"source": 0, "target": 4, "value": 4080, "province_territory": "Quebec", "year": "2018"}, {"source": 0, "target": 1, "value": 4, "province_territory": "Saskatchewan", "year": "2018"}, {"source": 0, "target": 2, "value": 670, "province_territory": "Saskatchewan", "year": "2018"}, {"source": 0, "target": 3, "value": 4325, "province_territory": "Saskatchewan", "year": "2018"}, {"source": 0, "target": 4, "value": 920, "province_territory": "Saskatchewan", "year": "2018"}, {"source": 0, "target": 2, "value": 6, "province_territory": "Yukon", "year": "2018"}, {"source": 0, "target": 3, "value": 53, "province_territory": "Yukon", "year": "2018"}, {"source": 0, "target": 4, "value": 15, "province_territory": "Yukon", "year": "2018"}, {"source": 0, "target": 1, "value": 30, "province_territory": "Alberta", "year": "2019"}, {"source": 0, "target": 2, "value": 1740, "province_territory": "Alberta", "year": "2019"}, {"source": 0, "target": 3, "value": 14455, "province_territory": "Alberta", "year": "2019"}, {"source": 0, "target": 4, "value": 4790, "province_territory": "Alberta", "year": "2019"}, {"source": 0, "target": 1, "value": 29, "province_territory": "British Columbia", "year": "2019"}, {"source": 0, "target": 2, "value": 10150, "province_territory": "British Columbia", "year": "2019"}, {"source": 0, "target": 3, "value": 57995, "province_territory": "British Columbia", "year": "2019"}, {"source": 0, "target": 4, "value": 20610, "province_territory": "British Columbia", "year": "2019"}, {"source": 0, "target": 1, "value": 6, "province_territory": "Manitoba", "year": "2019"}, {"source": 0, "target": 2, "value": 1080, "province_territory": "Manitoba", "year": "2019"}, {"source": 0, "target": 3, "value": 9835, "province_territory": "Manitoba", "year": "2019"}, {"source": 0, "target": 4, "value": 1755, "province_territory": "Manitoba", "year": "2019"}, {"source": 0, "target": 1, "value": 4, "province_territory": "New Brunswick", "year": "2019"}, {"source": 0, "target": 2, "value": 207, "province_territory": "New Brunswick", "year": "2019"}, {"source": 0, "target": 3, "value": 3190, "province_territory": "New Brunswick", "year": "2019"}, {"source": 0, "target": 4, "value": 1025, "province_territory": "New Brunswick", "year": "2019"}, {"source": 0, "target": 2, "value": 118, "province_territory": "Newfoundland and Labrador", "year": "2019"}, {"source": 0, "target": 3, "value": 2185, "province_territory": "Newfoundland and Labrador", "year": "2019"}, {"source": 0, "target": 4, "value": 375, "province_territory": "Newfoundland and Labrador", "year": "2019"}, {"source": 0, "target": 3, "value": 4, "province_territory": "Northwest Territories", "year": "2019"}, {"source": 0, "target": 4, "value": 28, "province_territory": "Northwest Territories", "year": "2019"}, {"source": 0, "target": 1, "value": 14, "province_territory": "Nova Scotia", "year": "2019"}, {"source": 0, "target": 2, "value": 1470, "province_territory": "Nova Scotia", "year": "2019"}, {"source": 0, "target": 3, "value": 7345, "province_territory": "Nova Scotia", "year": "2019"}, {"source": 0, "target": 4, "value": 1790, "province_territory": "Nova Scotia", "year": "2019"}, {"source": 0, "target": 3, "value": 8, "province_territory": "Nunavut", "year": "2019"}, {"source": 0, "target": 4, "value": 2, "province_territory": "Nunavut", "year": "2019"}, {"source": 0, "target": 1, "value": 57, "province_territory": "Ontario", "year": "2019"}, {"source": 0, "target": 2, "value": 20815, "province_territory": "Ontario", "year": "2019"}, {"source": 0, "target": 3, "value": 149245, "province_territory": "Ontario", "year": "2019"}, {"source": 0, "target": 4, "value": 33930, "province_territory": "Ontario", "year": "2019"}, {"source": 0, "target": 1, "value": 2, "province_territory": "Prince Edward Island", "year": "2019"}, {"source": 0, "target": 2, "value": 240, "province_territory": "Prince Edward Island", "year": "2019"}, {"source": 0, "target": 3, "value": 1275, "province_territory": "Prince Edward Island", "year": "2019"}, {"source": 0, "target": 4, "value": 415, "province_territory": "Prince Edward Island", "year": "2019"}, {"source": 0, "target": 1, "value": 13, "province_territory": "Quebec", "year": "2019"}, {"source": 0, "target": 2, "value": 7130, "province_territory": "Quebec", "year": "2019"}, {"source": 0, "target": 3, "value": 45835, "province_territory": "Quebec", "year": "2019"}, {"source": 0, "target": 4, "value": 5635, "province_territory": "Quebec", "year": "2019"}, {"source": 0, "target": 1, "value": 6, "province_territory": "Saskatchewan", "year": "2019"}, {"source": 0, "target": 2, "value": 520, "province_territory": "Saskatchewan", "year": "2019"}, {"source": 0, "target": 3, "value": 4755, "province_territory": "Saskatchewan", "year": "2019"}, {"source": 0, "target": 4, "value": 1130, "province_territory": "Saskatchewan", "year": "2019"}, {"source": 0, "target": 1, "value": 2, "province_territory": "Yukon", "year": "2019"}, {"source": 0, "target": 2, "value": 14, "province_territory": "Yukon", "year": "2019"}, {"source": 0, "target": 3, "value": 85, "province_territory": "Yukon", "year": "2019"}, {"source": 0, "target": 4, "value": 29, "province_territory": "Yukon", "year": "2019"}, {"source": 0, "target": 1, "value": 4, "province_territory": "Alberta", "year": "2020"}, {"source": 0, "target": 2, "value": 855, "province_territory": "Alberta", "year": "2020"}, {"source": 0, "target": 3, "value": 9210, "province_territory": "Alberta", "year": "2020"}, {"source": 0, "target": 4, "value": 3450, "province_territory": "Alberta", "year": "2020"}, {"source": 0, "target": 1, "value": 26, "province_territory": "British Columbia", "year": "2020"}, {"source": 0, "target": 2, "value": 4030, "province_territory": "British Columbia", "year": "2020"}, {"source": 0, "target": 3, "value": 44450, "province_territory": "British Columbia", "year": "2020"}, {"source": 0, "target": 4, "value": 14135, "province_territory": "British Columbia", "year": "2020"}, {"source": 0, "target": 1, "value": 8, "province_territory": "Manitoba", "year": "2020"}, {"source": 0, "target": 2, "value": 565, "province_territory": "Manitoba", "year": "2020"}, {"source": 0, "target": 3, "value": 7295, "province_territory": "Manitoba", "year": "2020"}, {"source": 0, "target": 4, "value": 1320, "province_territory": "Manitoba", "year": "2020"}, {"source": 0, "target": 2, "value": 105, "province_territory": "New Brunswick", "year": "2020"}, {"source": 0, "target": 3, "value": 1705, "province_territory": "New Brunswick", "year": "2020"}, {"source": 0, "target": 4, "value": 535, "province_territory": "New Brunswick", "year": "2020"}, {"source": 0, "target": 2, "value": 29, "province_territory": "Newfoundland and Labrador", "year": "2020"}, {"source": 0, "target": 3, "value": 1240, "province_territory": "Newfoundland and Labrador", "year": "2020"}, {"source": 0, "target": 4, "value": 175, "province_territory": "Newfoundland and Labrador", "year": "2020"}, {"source": 0, "target": 3, "value": 8, "province_territory": "Northwest Territories", "year": "2020"}, {"source": 0, "target": 4, "value": 12, "province_territory": "Northwest Territories", "year": "2020"}, {"source": 0, "target": 1, "value": 4, "province_territory": "Nova Scotia", "year": "2020"}, {"source": 0, "target": 2, "value": 385, "province_territory": "Nova Scotia", "year": "2020"}, {"source": 0, "target": 3, "value": 3840, "province_territory": "Nova Scotia", "year": "2020"}, {"source": 0, "target": 4, "value": 1065, "province_territory": "Nova Scotia", "year": "2020"}, {"source": 0, "target": 3, "value": 4, "province_territory": "Nunavut", "year": "2020"}, {"source": 0, "target": 4, "value": 2, "province_territory": "Nunavut", "year": "2020"}, {"source": 0, "target": 1, "value": 39, "province_territory": "Ontario", "year": "2020"}, {"source": 0, "target": 2, "value": 7600, "province_territory": "Ontario", "year": "2020"}, {"source": 0, "target": 3, "value": 97485, "province_territory": "Ontario", "year": "2020"}, {"source": 0, "target": 4, "value": 21980, "province_territory": "Ontario", "year": "2020"}, {"source": 0, "target": 1, "value": 2, "province_territory": "Prince Edward Island", "year": "2020"}, {"source": 0, "target": 2, "value": 268, "province_territory": "Prince Edward Island", "year": "2020"}, {"source": 0, "target": 3, "value": 760, "province_territory": "Prince Edward Island", "year": "2020"}, {"source": 0, "target": 4, "value": 295, "province_territory": "Prince Edward Island", "year": "2020"}, {"source": 0, "target": 1, "value": 14, "province_territory": "Quebec", "year": "2020"}, {"source": 0, "target": 2, "value": 5980, "province_territory": "Quebec", "year": "2020"}, {"source": 0, "target": 3, "value": 35115, "province_territory": "Quebec", "year": "2020"}, {"source": 0, "target": 4, "value": 4060, "province_territory": "Quebec", "year": "2020"}, {"source": 0, "target": 1, "value": 2, "province_territory": "Saskatchewan", "year": "2020"}, {"source": 0, "target": 2, "value": 127, "province_territory": "Saskatchewan", "year": "2020"}, {"source": 0, "target": 3, "value": 2650, "province_territory": "Saskatchewan", "year": "2020"}, {"source": 0, "target": 4, "value": 905, "province_territory": "Saskatchewan", "year": "2020"}, {"source": 0, "target": 1, "value": 2, "province_territory": "Yukon", "year": "2020"}, {"source": 0, "target": 2, "value": 4, "province_territory": "Yukon", "year": "2020"}, {"source": 0, "target": 3, "value": 78, "province_territory": "Yukon", "year": "2020"}, {"source": 0, "target": 4, "value": 39, "province_territory": "Yukon", "year": "2020"}, {"source": 0, "target": 1, "value": 16, "province_territory": "Alberta", "year": "2021"}, {"source": 0, "target": 2, "value": 1215, "province_territory": "Alberta", "year": "2021"}, {"source": 0, "target": 3, "value": 18080, "province_territory": "Alberta", "year": "2021"}, {"source": 0, "target": 4, "value": 5110, "province_territory": "Alberta", "year": "2021"}, {"source": 0, "target": 1, "value": 61, "province_territory": "British Columbia", "year": "2021"}, {"source": 0, "target": 2, "value": 8525, "province_territory": "British Columbia", "year": "2021"}, {"source": 0, "target": 3, "value": 67120, "province_territory": "British Columbia", "year": "2021"}, {"source": 0, "target": 4, "value": 22065, "province_territory": "British Columbia", "year": "2021"}, {"source": 0, "target": 1, "value": 8, "province_territory": "Manitoba", "year": "2021"}, {"source": 0, "target": 2, "value": 980, "province_territory": "Manitoba", "year": "2021"}, {"source": 0, "target": 3, "value": 9915, "province_territory": "Manitoba", "year": "2021"}, {"source": 0, "target": 4, "value": 2450, "province_territory": "Manitoba", "year": "2021"}, {"source": 0, "target": 1, "value": 2, "province_territory": "New Brunswick", "year": "2021"}, {"source": 0, "target": 2, "value": 174, "province_territory": "New Brunswick", "year": "2021"}, {"source": 0, "target": 3, "value": 4390, "province_territory": "New Brunswick", "year": "2021"}, {"source": 0, "target": 4, "value": 1505, "province_territory": "New Brunswick", "year": "2021"}, {"source": 0, "target": 2, "value": 43, "province_territory": "Newfoundland and Labrador", "year": "2021"}, {"source": 0, "target": 3, "value": 2795, "province_territory": "Newfoundland and Labrador", "year": "2021"}, {"source": 0, "target": 4, "value": 550, "province_territory": "Newfoundland and Labrador", "year": "2021"}, {"source": 0, "target": 3, "value": 14, "province_territory": "Northwest Territories", "year": "2021"}, {"source": 0, "target": 4, "value": 16, "province_territory": "Northwest Territories", "year": "2021"}, {"source": 0, "target": 1, "value": 6, "province_territory": "Nova Scotia", "year": "2021"}, {"source": 0, "target": 2, "value": 795, "province_territory": "Nova Scotia", "year": "2021"}, {"source": 0, "target": 3, "value": 7935, "province_territory": "Nova Scotia", "year": "2021"}, {"source": 0, "target": 4, "value": 1495, "province_territory": "Nova Scotia", "year": "2021"}, {"source": 0, "target": 2, "value": 2, "province_territory": "Nunavut", "year": "2021"}, {"source": 0, "target": 3, "value": 6, "province_territory": "Nunavut", "year": "2021"}, {"source": 0, "target": 4, "value": 2, "province_territory": "Nunavut", "year": "2021"}, {"source": 0, "target": 1, "value": 58, "province_territory": "Ontario", "year": "2021"}, {"source": 0, "target": 2, "value": 16555, "province_territory": "Ontario", "year": "2021"}, {"source": 0, "target": 3, "value": 186595, "province_territory": "Ontario", "year": "2021"}, {"source": 0, "target": 4, "value": 25815, "province_territory": "Ontario", "year": "2021"}, {"source": 0, "target": 2, "value": 209, "province_territory": "Prince Edward Island", "year": "2021"}, {"source": 0, "target": 3, "value": 1235, "province_territory": "Prince Edward Island", "year": "2021"}, {"source": 0, "target": 4, "value": 485, "province_territory": "Prince Edward Island", "year": "2021"}, {"source": 0, "target": 1, "value": 18, "province_territory": "Quebec", "year": "2021"}, {"source": 0, "target": 2, "value": 6480, "province_territory": "Quebec", "year": "2021"}, {"source": 0, "target": 3, "value": 53615, "province_territory": "Quebec", "year": "2021"}, {"source": 0, "target": 4, "value": 6430, "province_territory": "Quebec", "year": "2021"}, {"source": 0, "target": 1, "value": 6, "province_territory": "Saskatchewan", "year": "2021"}, {"source": 0, "target": 2, "value": 267, "province_territory": "Saskatchewan", "year": "2021"}, {"source": 0, "target": 3, "value": 4965, "province_territory": "Saskatchewan", "year": "2021"}, {"source": 0, "target": 4, "value": 1385, "province_territory": "Saskatchewan", "year": "2021"}, {"source": 0, "target": 2, "value": 8, "province_territory": "Yukon", "year": "2021"}, {"source": 0, "target": 3, "value": 118, "province_territory": "Yukon", "year": "2021"}, {"source": 0, "target": 4, "value": 77, "province_territory": "Yukon", "year": "2021"}, {"source": 0, "target": 1, "value": 10, "province_territory": "Alberta", "year": "2022"}, {"source": 0, "target": 2, "value": 1320, "province_territory": "Alberta", "year": "2022"}, {"source": 0, "target": 3, "value": 20480, "province_territory": "Alberta", "year": "2022"}, {"source": 0, "target": 4, "value": 7630, "province_territory": "Alberta", "year": "2022"}, {"source": 0, "target": 1, "value": 36, "province_territory": "British Columbia", "year": "2022"}, {"source": 0, "target": 2, "value": 9440, "province_territory": "British Columbia", "year": "2022"}, {"source": 0, "target": 3, "value": 80035, "province_territory": "British Columbia", "year": "2022"}, {"source": 0, "target": 4, "value": 24820, "province_territory": "British Columbia", "year": "2022"}, {"source": 0, "target": 1, "value": 4, "province_territory": "Manitoba", "year": "2022"}, {"source": 0, "target": 2, "value": 1100, "province_territory": "Manitoba", "year": "2022"}, {"source": 0, "target": 3, "value": 11210, "province_territory": "Manitoba", "year": "2022"}, {"source": 0, "target": 4, "value": 3240, "province_territory": "Manitoba", "year": "2022"}, {"source": 0, "target": 1, "value": 6, "province_territory": "New Brunswick", "year": "2022"}, {"source": 0, "target": 2, "value": 134, "province_territory": "New Brunswick", "year": "2022"}, {"source": 0, "target": 3, "value": 5625, "province_territory": "New Brunswick", "year": "2022"}, {"source": 0, "target": 4, "value": 2085, "province_territory": "New Brunswick", "year": "2022"}, {"source": 0, "target": 2, "value": 56, "province_territory": "Newfoundland and Labrador", "year": "2022"}, {"source": 0, "target": 3, "value": 3105, "province_territory": "Newfoundland and Labrador", "year": "2022"}, {"source": 0, "target": 4, "value": 850, "province_territory": "Newfoundland and Labrador", "year": "2022"}, {"source": 0, "target": 3, "value": 14, "province_territory": "Northwest Territories", "year": "2022"}, {"source": 0, "target": 4, "value": 28, "province_territory": "Northwest Territories", "year": "2022"}, {"source": 0, "target": 1, "value": 2, "province_territory": "Nova Scotia", "year": "2022"}, {"source": 0, "target": 2, "value": 980, "province_territory": "Nova Scotia", "year": "2022"}, {"source": 0, "target": 3, "value": 9925, "province_territory": "Nova Scotia", "year": "2022"}, {"source": 0, "target": 4, "value": 2575, "province_territory": "Nova Scotia", "year": "2022"}, {"source": 0, "target": 3, "value": 4, "province_territory": "Nunavut", "year": "2022"}, {"source": 0, "target": 1, "value": 70, "province_territory": "Ontario", "year": "2022"}, {"source": 0, "target": 2, "value": 21985, "province_territory": "Ontario", "year": "2022"}, {"source": 0, "target": 3, "value": 247105, "province_territory": "Ontario", "year": "2022"}, {"source": 0, "target": 4, "value": 32970, "province_territory": "Ontario", "year": "2022"}, {"source": 0, "target": 1, "value": 4, "province_territory": "Prince Edward Island", "year": "2022"}, {"source": 0, "target": 2, "value": 230, "province_territory": "Prince Edward Island", "year": "2022"}, {"source": 0, "target": 3, "value": 1630, "province_territory": "Prince Edward Island", "year": "2022"}, {"source": 0, "target": 4, "value": 615, "province_territory": "Prince Edward Island", "year": "2022"}, {"source": 0, "target": 1, "value": 11, "province_territory": "Quebec", "year": "2022"}, {"source": 0, "target": 2, "value": 6640, "province_territory": "Quebec", "year": "2022"}, {"source": 0, "target": 3, "value": 52140, "province_territory": "Quebec", "year": "2022"}, {"source": 0, "target": 4, "value": 7050, "province_territory": "Quebec", "year": "2022"}, {"source": 0, "target": 1, "value": 8, "province_territory": "Saskatchewan", "year": "2022"}, {"source": 0, "target": 2, "value": 350, "province_territory": "Saskatchewan", "year": "2022"}, {"source": 0, "target": 3, "value": 6300, "province_territory": "Saskatchewan", "year": "2022"}, {"source": 0, "target": 4, "value": 2060, "province_territory": "Saskatchewan", "year": "2022"}, {"source": 0, "target": 2, "value": 2, "province_territory": "Yukon", "year": "2022"}, {"source": 0, "target": 3, "value": 73, "province_territory": "Yukon", "year": "2022"}, {"source": 0, "target": 4, "value": 94, "province_territory": "Yukon", "year": "2022"}, {"source": 0, "target": 1, "value": 23, "province_territory": "Alberta", "year": "2023"}, {"source": 0, "target": 2, "value": 1605, "province_territory": "Alberta", "year": "2023"}, {"source": 0, "target": 3, "value": 28960, "province_territory": "Alberta", "year": "2023"}, {"source": 0, "target": 4, "value": 12500, "province_territory": "Alberta", "year": "2023"}, {"source": 0, "target": 1, "value": 33, "province_territory": "British Columbia", "year": "2023"}, {"source": 0, "target": 2, "value": 8105, "province_territory": "British Columbia", "year": "2023"}, {"source": 0, "target": 3, "value": 93820, "province_territory": "British Columbia", "year": "2023"}, {"source": 0, "target": 4, "value": 28725, "province_territory": "British Columbia", "year": "2023"}, {"source": 0, "target": 1, "value": 10, "province_territory": "Manitoba", "year": "2023"}, {"source": 0, "target": 2, "value": 1090, "province_territory": "Manitoba", "year": "2023"}, {"source": 0, "target": 3, "value": 14190, "province_territory": "Manitoba", "year": "2023"}, {"source": 0, "target": 4, "value": 4740, "province_territory": "Manitoba", "year": "2023"}, {"source": 0, "target": 1, "value": 8, "province_territory": "New Brunswick", "year": "2023"}, {"source": 0, "target": 2, "value": 209, "province_territory": "New Brunswick", "year": "2023"}, {"source": 0, "target": 3, "value": 7920, "province_territory": "New Brunswick", "year": "2023"}, {"source": 0, "target": 4, "value": 3075, "province_territory": "New Brunswick", "year": "2023"}, {"source": 0, "target": 1, "value": 2, "province_territory": "Newfoundland and Labrador", "year": "2023"}, {"source": 0, "target": 2, "value": 83, "province_territory": "Newfoundland and Labrador", "year": "2023"}, {"source": 0, "target": 3, "value": 3295, "province_territory": "Newfoundland and Labrador", "year": "2023"}, {"source": 0, "target": 4, "value": 885, "province_territory": "Newfoundland and Labrador", "year": "2023"}, {"source": 0, "target": 2, "value": 2, "province_territory": "Northwest Territories", "year": "2023"}, {"source": 0, "target": 3, "value": 16, "province_territory": "Northwest Territories", "year": "2023"}, {"source": 0, "target": 4, "value": 36, "province_territory": "Northwest Territories", "year": "2023"}, {"source": 0, "target": 1, "value": 14, "province_territory": "Nova Scotia", "year": "2023"}, {"source": 0, "target": 2, "value": 815, "province_territory": "Nova Scotia", "year": "2023"}, {"source": 0, "target": 3, "value": 11695, "province_territory": "Nova Scotia", "year": "2023"}, {"source": 0, "target": 4, "value": 3880, "province_territory": "Nova Scotia", "year": "2023"}, {"source": 0, "target": 3, "value": 10, "province_territory": "Nunavut", "year": "2023"}, {"source": 0, "target": 4, "value": 2, "province_territory": "Nunavut", "year": "2023"}, {"source": 0, "target": 1, "value": 91, "province_territory": "Ontario", "year": "2023"}, {"source": 0, "target": 2, "value": 23810, "province_territory": "Ontario", "year": "2023"}, {"source": 0, "target": 3, "value": 302100, "province_territory": "Ontario", "year": "2023"}, {"source": 0, "target": 4, "value": 47730, "province_territory": "Ontario", "year": "2023"}, {"source": 0, "target": 1, "value": 2, "province_territory": "Prince Edward Island", "year": "2023"}, {"source": 0, "target": 2, "value": 495, "province_territory": "Prince Edward Island", "year": "2023"}, {"source": 0, "target": 3, "value": 1900, "province_territory": "Prince Edward Island", "year": "2023"}, {"source": 0, "target": 4, "value": 770, "province_territory": "Prince Edward Island", "year": "2023"}, {"source": 0, "target": 1, "value": 19, "province_territory": "Quebec", "year": "2023"}, {"source": 0, "target": 2, "value": 8930, "province_territory": "Quebec", "year": "2023"}, {"source": 0, "target": 3, "value": 61595, "province_territory": "Quebec", "year": "2023"}, {"source": 0, "target": 4, "value": 10300, "province_territory": "Quebec", "year": "2023"}, {"source": 0, "target": 1, "value": 13, "province_territory": "Saskatchewan", "year": "2023"}, {"source": 0, "target": 2, "value": 455, "province_territory": "Saskatchewan", "year": "2023"}, {"source": 0, "target": 3, "value": 8875, "province_territory": "Saskatchewan", "year": "2023"}, {"source": 0, "target": 4, "value": 3030, "province_territory": "Saskatchewan", "year": "2023"}, {"source": 0, "target": 2, "value": 10, "province_territory": "Yukon", "year": "2023"}, {"source": 0, "target": 3, "value": 113, "province_territory": "Yukon", "year": "2023"}, {"source": 0, "target": 4, "value": 142, "province_territory": "Yukon", "year": "2023"}, {"source": 0, "target": 1, "value": 18, "province_territory": "Alberta", "year": "2024"}, {"source": 0, "target": 2, "value": 1435, "province_territory": "Alberta", "year": "2024"}, {"source": 0, "target": 3, "value": 25940, "province_territory": "Alberta", "year": "2024"}, {"source": 0, "target": 4, "value": 13040, "province_territory": "Alberta", "year": "2024"}, {"source": 0, "target": 1, "value": 49, "province_territory": "British Columbia", "year": "2024"}, {"source": 0, "target": 2, "value": 5840, "province_territory": "British Columbia", "year": "2024"}, {"source": 0, "target": 3, "value": 71830, "province_territory": "British Columbia", "year": "2024"}, {"source": 0, "target": 4, "value": 26505, "province_territory": "British Columbia", "year": "2024"}, {"source": 0, "target": 1, "value": 14, "province_territory": "Manitoba", "year": "2024"}, {"source": 0, "target": 2, "value": 755, "province_territory": "Manitoba", "year": "2024"}, {"source": 0, "target": 3, "value": 10640, "province_territory": "Manitoba", "year": "2024"}, {"source": 0, "target": 4, "value": 4430, "province_territory": "Manitoba", "year": "2024"}, {"source": 0, "target": 1, "value": 4, "province_territory": "New Brunswick", "year": "2024"}, {"source": 0, "target": 2, "value": 114, "province_territory": "New Brunswick", "year": "2024"}, {"source": 0, "target": 3, "value": 5385, "province_territory": "New Brunswick", "year": "2024"}, {"source": 0, "target": 4, "value": 2820, "province_territory": "New Brunswick", "year": "2024"}, {"source": 0, "target": 1, "value": 4, "province_territory": "Newfoundland and Labrador", "year": "2024"}, {"source": 0, "target": 2, "value": 56, "province_territory": "Newfoundland and Labrador", "year": "2024"}, {"source": 0, "target": 3, "value": 2270, "province_territory": "Newfoundland and Labrador", "year": "2024"}, {"source": 0, "target": 4, "value": 1155, "province_territory": "Newfoundland and Labrador", "year": "2024"}, {"source": 0, "target": 3, "value": 34, "province_territory": "Northwest Territories", "year": "2024"}, {"source": 0, "target": 4, "value": 42, "province_territory": "Northwest Territories", "year": "2024"}, {"source": 0, "target": 1, "value": 4, "province_territory": "Nova Scotia", "year": "2024"}, {"source": 0, "target": 2, "value": 560, "province_territory": "Nova Scotia", "year": "2024"}, {"source": 0, "target": 3, "value": 7205, "province_territory": "Nova Scotia", "year": "2024"}, {"source": 0, "target": 4, "value": 3415, "province_territory": "Nova Scotia", "year": "2024"}, {"source": 0, "target": 3, "value": 6, "province_territory": "Nunavut", "year": "2024"}, {"source": 0, "target": 4, "value": 11, "province_territory": "Nunavut", "year": "2024"}, {"source": 0, "target": 1, "value": 95, "province_territory": "Ontario", "year": "2024"}, {"source": 0, "target": 2, "value": 13860, "province_territory": "Ontario", "year": "2024"}, {"source": 0, "target": 3, "value": 196800, "province_territory": "Ontario", "year": "2024"}, {"source": 0, "target": 4, "value": 46510, "province_territory": "Ontario", "year": "2024"}, {"source": 0, "target": 2, "value": 280, "province_territory": "Prince Edward Island", "year": "2024"}, {"source": 0, "target": 3, "value": 1145, "province_territory": "Prince Edward Island", "year": "2024"}, {"source": 0, "target": 4, "value": 800, "province_territory": "Prince Edward Island", "year": "2024"}, {"source": 0, "target": 1, "value": 20, "province_territory": "Quebec", "year": "2024"}, {"source": 0, "target": 2, "value": 12855, "province_territory": "Quebec", "year": "2024"}, {"source": 0, "target": 3, "value": 50735, "province_territory": "Quebec", "year": "2024"}, {"source": 0, "target": 4, "value": 11120, "province_territory": "Quebec", "year": "2024"}, {"source": 0, "target": 1, "value": 8, "province_territory": "Saskatchewan", "year": "2024"}, {"source": 0, "target": 2, "value": 330, "province_territory": "Saskatchewan", "year": "2024"}, {"source": 0, "target": 3, "value": 6160, "province_territory": "Saskatchewan", "year": "2024"}, {"source": 0, "target": 4, "value": 3175, "province_territory": "Saskatchewan", "year": "2024"}, {"source": 0, "target": 1, "value": 6, "province_territory": "Yukon", "year": "2024"}, {"source": 0, "target": 2, "value": 10, "province_territory": "Yukon", "year": "2024"}, {"source": 0, "target": 3, "value": 110, "province_territory": "Yukon", "year": "2024"}, {"source": 0, "target": 4, "value": 97, "province_territory": "Yukon", "year": "2024"}, {"source": 0, "target": 1, "value": 10, "province_territory": "Alberta", "year": "2025"}, {"source": 0, "target": 2, "value": 435, "province_territory": "Alberta", "year": "2025"}, {"source": 0, "target": 3, "value": 7305, "province_territory": "Alberta", "year": "2025"}, {"source": 0, "target": 4, "value": 7100, "province_territory": "Alberta", "year": "2025"}, {"source": 0, "target": 1, "value": 10, "province_territory": "British Columbia", "year": "2025"}, {"source": 0, "target": 2, "value": 1540, "province_territory": "British Columbia", "year": "2025"}, {"source": 0, "target": 3, "value": 22735, "province_territory": "British Columbia", "year": "2025"}, {"source": 0, "target": 4, "value": 10385, "province_territory": "British Columbia", "year": "2025"}, {"source": 0, "target": 1, "value": 2, "province_territory": "Manitoba", "year": "2025"}, {"source": 0, "target": 2, "value": 220, "province_territory": "Manitoba", "year": "2025"}, {"source": 0, "target": 3, "value": 4230, "province_territory": "Manitoba", "year": "2025"}, {"source": 0, "target": 4, "value": 2155, "province_territory": "Manitoba", "year": "2025"}, {"source": 0, "target": 2, "value": 59, "province_territory": "New Brunswick", "year": "2025"}, {"source": 0, "target": 3, "value": 2060, "province_territory": "New Brunswick", "year": "2025"}, {"source": 0, "target": 4, "value": 1310, "province_territory": "New Brunswick", "year": "2025"}, {"source": 0, "target": 1, "value": 4, "province_territory": "Newfoundland and Labrador", "year": "2025"}, {"source": 0, "target": 2, "value": 10, "province_territory": "Newfoundland and Labrador", "year": "2025"}, {"source": 0, "target": 3, "value": 715, "province_territory": "Newfoundland and Labrador", "year": "2025"}, {"source": 0, "target": 4, "value": 555, "province_territory": "Newfoundland and Labrador", "year": "2025"}, {"source": 0, "target": 3, "value": 4, "province_territory": "Northwest Territories", "year": "2025"}, {"source": 0, "target": 4, "value": 31, "province_territory": "Northwest Territories", "year": "2025"}, {"source": 0, "target": 1, "value": 2, "province_territory": "Nova Scotia", "year": "2025"}, {"source": 0, "target": 2, "value": 245, "province_territory": "Nova Scotia", "year": "2025"}, {"source": 0, "target": 3, "value": 2275, "province_territory": "Nova Scotia", "year": "2025"}, {"source": 0, "target": 4, "value": 1435, "province_territory": "Nova Scotia", "year": "2025"}, {"source": 0, "target": 3, "value": 2, "province_territory": "Nunavut", "year": "2025"}, {"source": 0, "target": 4, "value": 6, "province_territory": "Nunavut", "year": "2025"}, {"source": 0, "target": 1, "value": 22, "province_territory": "Ontario", "year": "2025"}, {"source": 0, "target": 2, "value": 2965, "province_territory": "Ontario", "year": "2025"}, {"source": 0, "target": 3, "value": 54230, "province_territory": "Ontario", "year": "2025"}, {"source": 0, "target": 4, "value": 20805, "province_territory": "Ontario", "year": "2025"}, {"source": 0, "target": 2, "value": 197, "province_territory": "Prince Edward Island", "year": "2025"}, {"source": 0, "target": 3, "value": 380, "province_territory": "Prince Edward Island", "year": "2025"}, {"source": 0, "target": 4, "value": 275, "province_territory": "Prince Edward Island", "year": "2025"}, {"source": 0, "target": 1, "value": 10, "province_territory": "Quebec", "year": "2025"}, {"source": 0, "target": 2, "value": 4900, "province_territory": "Quebec", "year": "2025"}, {"source": 0, "target": 3, "value": 14945, "province_territory": "Quebec", "year": "2025"}, {"source": 0, "target": 4, "value": 5585, "province_territory": "Quebec", "year": "2025"}, {"source": 0, "target": 2, "value": 67, "province_territory": "Saskatchewan", "year": "2025"}, {"source": 0, "target": 3, "value": 1805, "province_territory": "Saskatchewan", "year": "2025"}, {"source": 0, "target": 4, "value": 1550, "province_territory": "Saskatchewan", "year": "2025"}, {"source": 0, "target": 2, "value": 2, "province_territory": "Yukon", "year": "2025"}, {"source": 0, "target": 3, "value": 37, "province_territory": "Yukon", "year": "2025"}, {"source": 0, "target": 4, "value": 32, "province_territory": "Yukon", "year": "2025"}];
    // END DATA
  </script>

  <script>
    // Setup
    const margin = {top: 10, right: 10, bottom: 10, left: 10};
    const width = document.getElementById('chart').clientWidth - margin.left - margin.right;
    const height = 720 - margin.top - margin.bottom;

    const provinceSel = document.getElementById('provinceSelect');
    const yearSel = document.getElementById('yearSelect');
    const summaryEl = document.getElementById('summary');
    const tooltip = d3.select('#tooltip');

    // Format numbers
    function formatNumber(num) {
      if (num >= 1000000) return (num / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
      if (num >= 1000) return (num / 1000).toFixed(1).replace(/\.0$/, '') + 'k';
      return num.toString();
    }

    function init() {
      // Build filter lists from links
      const provs = Array.from(new Set(LINKS.map(l => String(l.province_territory)))).sort();
      const years = Array.from(new Set(LINKS.map(l => String(l.year)))).sort((a,b)=>a.localeCompare(b));

      for (const p of provs) {
        const opt = document.createElement('option');
        opt.value = p;
        opt.textContent = p;
        provinceSel.appendChild(opt);
      }
      for (const y of years) {
        const opt = document.createElement('option');
        opt.value = y;
        opt.textContent = y;
        yearSel.appendChild(opt);
      }

      provinceSel.addEventListener('change', render);
      yearSel.addEventListener('change', render);

      render();
    }

    function render() {
      const p = provinceSel.value;
      const y = yearSel.value;

      // Filter links
      const filtered = LINKS.filter(l => 
        (p === 'ALL' || String(l.province_territory) === p) &&
        (y === 'ALL' || String(l.year) === y)
      );

      // Aggregate links
      const edgeMap = new Map();
      let totalValue = 0;
      for (const row of filtered) {
        const s = Number(row.source);
        const t = Number(row.target);
        const v = Number(row.value) || 0;
        const key = `${s}-${t}`;
        totalValue += v;
        if (!edgeMap.has(key)) {
          edgeMap.set(key, {source: s, target: t, value: 0});
        }
        edgeMap.get(key).value += v;
      }
      const aggregatedLinks = Array.from(edgeMap.values());

      // Update summary
      summaryEl.textContent = `${p==='ALL'?'All provinces':p} · ${y==='ALL'?'All years':y}`;

      // Count nodes with values
      const nodeValues = new Map();
      for (const link of aggregatedLinks) {
        nodeValues.set(link.source, (nodeValues.get(link.source) || 0) + link.value);
        nodeValues.set(link.target, (nodeValues.get(link.target) || 0) + link.value);
      }
      // Build hierarchy paths for nodes using original link structure
      function getNodePath(nodeId) {
        const node = NODES.find(n => n.id === nodeId);
        if (!node) return '';
        
        const path = [];
        let currentId = nodeId;
        const maxDepth = 10; // Safety limit
        let depth = 0;
        
        // Walk up the hierarchy using ALL links (not filtered), to show structural hierarchy
        while (currentId !== undefined && depth < maxDepth) {
          const currentNode = NODES.find(n => n.id === currentId);
          if (currentNode && currentNode.level !== 0) { // Skip root
            path.unshift(currentNode.label);
          }
          
          // Find parent using any link (from original LINKS, not aggregated)
          const parentLink = LINKS.find(l => l.target === currentId);
          currentId = parentLink ? parentLink.source : undefined;
          depth++;
        }
        
        return path.join(' → ');
      }
      
      // Display zero-flow nodes with hierarchy
      const legendDiv = document.getElementById('small-nodes-legend');
      
      // Only show nodes with exactly zero flow (not in nodeValues)
      const zeroFlowNodes = NODES.filter(n => 
        n.level > 0 && !nodeValues.has(n.id)
      ).map(n => [n.id, 0]);
      
      if (zeroFlowNodes.length > 0) {
        const nodesWithPaths = zeroFlowNodes.map(([id, val]) => ({
          id,
          value: val,
          path: getNodePath(id)
        })).sort((a, b) => a.path.localeCompare(b.path));
        
        legendDiv.innerHTML = `
          <strong>Nodes with zero flow (${zeroFlowNodes.length}):</strong>
          <div style="columns: 2; column-gap: 20px; margin-top: 8px;">
            ${nodesWithPaths.map(n => 
              `<div style="margin-bottom: 4px; break-inside: avoid;">
                <span style="color: #999;">▪</span> ${n.path} <span style="color: #999;">(0)</span>
              </div>`
            ).join('')}
          </div>
        `;
      } else {
        legendDiv.innerHTML = '';
      }

      // Prepare D3 Sankey data
      const nodesWithFlow = new Set(nodeValues.keys());
      
      // D3 Sankey needs nodes as objects with name property and modifies them in place
      const sankeyNodes = NODES
        .filter(n => nodesWithFlow.has(n.id))
        .map(n => ({
          id: n.id,
          name: n.label,
          level: n.level
        }));

      const sankeyLinks = aggregatedLinks.map(l => ({
        source: l.source,
        target: l.target,
        value: l.value
      }));

      // Hierarchical sort by level then by value
      const nodeOrder = new Map();
      let orderCounter = 0;
      const nodesByLevel = new Map();
      for (const node of sankeyNodes) {
        const level = node.level || 0;
        if (!nodesByLevel.has(level)) nodesByLevel.set(level, []);
        nodesByLevel.get(level).push(node);
      }
      const maxLevel = Math.max(...Array.from(nodesByLevel.keys()));
      for (let level = 0; level <= maxLevel; level++) {
        const nodesAtLevel = nodesByLevel.get(level) || [];
        nodesAtLevel.sort((a, b) => (b.value || 0) - (a.value || 0));
        nodesAtLevel.forEach(n => nodeOrder.set(n.id, orderCounter++));
      }
      function hierarchicalSort(a, b) {
        const orderA = nodeOrder.get(a.id);
        const orderB = nodeOrder.get(b.id);
        return (orderA || 0) - (orderB || 0);
      }

      // Create Sankey generator
      const sankey = d3.sankey()
        .nodeId(d => d.id)
        .nodeAlign(d3.sankeyLeft)
        .nodeWidth(20)
        .nodePadding(15)
        .nodeSort(hierarchicalSort)
        .extent([[margin.left, margin.top], [width - margin.right, height - margin.bottom]]);

      const graph = sankey({
        nodes: sankeyNodes,
        links: sankeyLinks
      });

      // Color mapping by study_level (level 1) - use original NODES array for consistent colors
      const category1Nodes = NODES.filter(n => n.level === 1);
      const category1Colors = new Map();
      category1Nodes.forEach((node, i) => {
        category1Colors.set(node.id, d3.schemeCategory10[i % 10]);
      });
      function getNodeColor(nodeId) {
        return category1Colors.get(nodeId) || '#999';
      }

      // Clear previous chart
      d3.select('#chart').selectAll('*').remove();

      // Create SVG
      const svg = d3.select('#chart')
        .append('svg')
        .attr('width', width + margin.left + margin.right)
        .attr('height', height + margin.top + margin.bottom)
        .append('g')
        .attr('transform', `translate(${margin.left},${margin.top})`);

      // Add links
      const link = svg.append('g')
        .attr('class', 'links')
        .selectAll('path')
        .data(graph.links)
        .join('path')
        .attr('class', 'link')
        .attr('d', d3.sankeyLinkHorizontal())
        .attr('stroke-width', d => Math.max(1, d.width))
        .attr('stroke', d => {
          const color = getNodeColor(d.target.id);
          const rgb = d3.color(color);
          return `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.4)`;
        })
        .on('mouseover', function(event, d) {
          d3.select(this).attr('stroke-opacity', 0.8);
          tooltip
            .style('opacity', 1)
            .html(`${d.source.name} → ${d.target.name}<br/>Value: ${formatNumber(d.value)}`)
            .style('left', (event.pageX + 10) + 'px')
            .style('top', (event.pageY - 10) + 'px');
        })
        .on('mousemove', function(event) {
          tooltip
            .style('left', (event.pageX + 10) + 'px')
            .style('top', (event.pageY - 10) + 'px');
        })
        .on('mouseout', function() {
          d3.select(this).attr('stroke-opacity', 0.5);
          tooltip.style('opacity', 0);
        });

      // Add nodes with minimum height for visibility
      const MIN_NODE_HEIGHT = 3;
      const node = svg.append('g')
        .attr('class', 'nodes')
        .selectAll('g')
        .data(graph.nodes)
        .join('g')
        .attr('class', 'node');

      node.append('rect')
        .attr('x', d => d.x0)
        .attr('y', d => {
          const actualHeight = d.y1 - d.y0;
          return actualHeight < MIN_NODE_HEIGHT ? d.y0 - (MIN_NODE_HEIGHT - actualHeight) / 2 : d.y0;
        })
        .attr('height', d => Math.max(MIN_NODE_HEIGHT, d.y1 - d.y0))
        .attr('width', d => d.x1 - d.x0)
        .attr('fill', d => getNodeColor(d.id))
        .attr('stroke', '#999')
        .attr('stroke-width', 0.5)
        .on('mouseover', function(event, d) {
          tooltip
            .style('opacity', 1)
            .html(`${d.name}<br/>Value: ${formatNumber(d.value || 0)}`)
            .style('left', (event.pageX + 10) + 'px')
            .style('top', (event.pageY - 10) + 'px');
        })
        .on('mousemove', function(event) {
          tooltip
            .style('left', (event.pageX + 10) + 'px')
            .style('top', (event.pageY - 10) + 'px');
        })
        .on('mouseout', function() {
          tooltip.style('opacity', 0);
        });

      // Calculate parent percentages for node labels
      function getNodeLabel(node) {
        const val = node.value || 0;
        if (val <= 0) return node.name;
        
        // For Study chart: all level 1 nodes have Study (level 0) as parent
        if (node.level === 1) {
          const studyNode = graph.nodes.find(n => n.level === 0);
          if (studyNode && studyNode.value > 0) {
            const percentage = ((val / studyNode.value) * 100).toFixed(1);
            return `${node.name} (${formatNumber(val)}, ${percentage}%)`;
          }
        }
        
        // For root node or if no parent found, just show value
        return `${node.name} (${formatNumber(val)})`;
      }

      // Labels
      node.append('text')
        .attr('x', d => d.x0 < width / 2 ? d.x1 + 6 : d.x0 - 6)
        .attr('y', d => (d.y1 + d.y0) / 2)
        .attr('dy', '0.35em')
        .attr('text-anchor', d => d.x0 < width / 2 ? 'start' : 'end')
        .text(d => getNodeLabel(d));
    }

    init();
  </script>
</body>
</html>



